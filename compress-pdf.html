<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-57TC57Z3');</script>
<!-- End Google Tag Manager -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KC8H85HKF1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KC8H85HKF1');
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compress PDF | Reduce PDF Size Online Free - PDF99</title>
  <meta name="description"
    content="Compress PDF files in seconds. Reduce PDF size with adjustable compression levels - all in your browser." />
  <meta name="keywords"
    content="compress pdf, pdf compressor, reduce pdf size, shrink pdf, optimize pdf, compress pdf online, free pdf compressor, make pdf smaller, compress large pdf, reduce pdf file size online" />
  <link rel="canonical" href="https://www.pdf99.org/compress-pdf" />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#ef4444" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Compress PDF - PDF99" />
  <meta property="og:description"
    content="Compress PDF files in seconds. Reduce PDF size with adjustable compression levels - all in your browser." />
  <meta property="og:url" content="https://www.pdf99.org/compress-pdf" />
  <meta property="og:site_name" content="PDF99" />
  <meta property="og:image" content="https://www.pdf99.org/assets/og-image-compress-pdf.png" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Compress PDF - PDF99" />
  <meta name="twitter:description"
    content="Compress PDF files in seconds. Reduce PDF size with adjustable compression levels - all in your browser." />
  <meta name="twitter:image" content="https://www.pdf99.org/assets/og-image-compress-pdf.png" />

  <!-- Performance hints -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    as="style" />

  <!-- Favicon & manifest -->
  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="assets/img/apple-touch-icon.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Structured data (JSON-LD) -->

    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "SoftwareApplication",
      "@id": "https://www.pdf99.org/compress-pdf#software",
      "name": "Compress PDF",
      "url": "https://www.pdf99.org/compress-pdf",
      "description": "Reduce PDF file size while maintaining quality using PDF99's Compress PDF tool - fast, secure, and done entirely in the browser.",
      "applicationCategory": "Utilities",
      "operatingSystem": "Web"
    },
    {
      "@type": "BreadcrumbList",
      "@id": "https://www.pdf99.org/compress-pdf#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://www.pdf99.org/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Compress PDF",
          "item": "https://www.pdf99.org/compress-pdf"
        }
      ]
    }
  ]
}
</script>


  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    if (window["pdfjsLib"])
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    /* Hide scrollbar universally but keep scroll functionality */

    /* For Chrome, Safari, Edge */
    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
      display: none;
      /* hide scrollbar */
      width: 0 !important;
      /* ensure no width */
      height: 0 !important;
    }

    :root {
      --nav-h: 72px;
      --footer-h: 64px;
      --settings-w: 320px;
      --content-max-w: 1200px;
      --fab-bottom-base: 16px;
      --fab-vertical-gap: 72px;
    }

    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
        "Helvetica Neue", Arial;
    }

    html,
    body {
      height: 100%;
      margin: 0;


      scrollbar-width: none;
      /* hide scrollbar */
      -ms-overflow-style: none;
      /* hide scrollbar */
    }

    body {
      background: #f9fafb;
      padding-top: var(--nav-h);
      padding-bottom: var(--footer-h);
    }

    nav.site-nav {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      height: var(--nav-h);
      background: #fff;
      border-bottom: 1px solid #eee;
      z-index: 60;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-inner {
      width: 100%;
      max-width: var(--content-max-w);
      margin: 0 auto;
      display: flex;
      align-items: center;
      position: relative;
      padding: 0 18px;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 70;
    }

    .nav-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .nav-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 70;
    }

    .nav-links {
      color: #374151;
      font-size: 13px;
      text-transform: uppercase;
      gap: 14px;
      display: flex;
      align-items: center;
    }

    .more-dropdown {
      position: relative;
    }

    .more-dropdown-menu {
      position: absolute;
      top: calc(var(--nav-h));
      right: 0;
      background: #fff;
      border: 1px solid #e6edf3;
      border-radius: 8px;
      padding: 8px 0;
      display: none;
      min-width: 200px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
    }

    .more-dropdown-menu.open {
      display: block;
    }

    .more-dropdown-menu a {
      display: block;
      padding: 8px 16px;
      color: #374151;
      text-decoration: none;
      font-size: 14px;
    }

    .more-dropdown-menu a:hover {
      background: #fbfbfd;
      color: #ef4444;
    }

    @media (max-width: 768px) {
      .more-dropdown {
        display: none !important;
      }

      .nav-center {
        display: none !important;
      }
    }

    .mobile-hamburger {
      display: none;
      border: 0;
      background: transparent;
      font-size: 20px;
    }

    @media (max-width: 768px) {
      .mobile-hamburger {
        display: inline-flex;
      }
    }

    .mobile-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 260px;
      background: #fff;
      transform: translateX(-110%);
      transition: transform 0.26s;
      padding: 16px;
      border-right: 1px solid #eef2f6;
      z-index: 980;
      overflow: auto;
    }

    .mobile-sidebar.open {
      transform: translateX(0);
    }

    .mobile-sidebar .close {
      display: block;
      margin-bottom: 12px;
      margin-left: auto;
      font-size: 1.2rem;
      font-weight: 900;
    }

    .mobile-sidebar a {
      display: block;
      padding: 10px 8px;
      color: #333;
      text-decoration: none;
      border-radius: 6px;
    }

    .mobile-sidebar a:hover {
      background: #f8fafc;
      color: #ef4444;
    }

    .mobile-more-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 8px;
      border-radius: 6px;
      cursor: pointer;
    }

    .mobile-more-list {
      display: none;
      margin-top: 6px;
      padding-left: 6px;
    }

    .mobile-more-list a {
      padding: 8px 6px;
      display: block;
      color: #333;
      text-decoration: none;
      border-radius: 6px;
    }

    .mobile-more-list.open {
      display: block;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.45);
      z-index: 920;
      display: none;
    }

    .overlay.open {
      display: block;
    }

    footer.site-footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--footer-h);
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 1px solid #eee;
      z-index: 60;
    }

    .page-wrap {
      max-width: var(--content-max-w);
      margin: 0 auto;
      padding: 18px;
    }

    .settings-panel {
      transition: transform 0.24s;
    }

    @media (min-width: 769px) {
      .settings-panel {
        position: fixed;
        right: 0;
        top: var(--nav-h);
        bottom: var(--footer-h);
        width: var(--settings-w);
        background: #fff;
        border-radius: 0;
        box-shadow: none;
        border-left: 1px solid #f1f5f9;
        padding: 20px;
        overflow: auto;
        z-index: 960;
      }

      .main-content {
        margin-right: calc(var(--settings-w) + 18px);
        position: relative;
      }

      .add-more-btn {
        position: fixed;
        right: calc(var(--settings-w) + 12px);
        bottom: 15%;
        transform: translateY(-50%);
        z-index: 940;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      }

      #convert-btn-desktop {
        position: absolute;
        left: 20px;
        right: 20px;
        bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .settings-panel .content-padding-bottom {
        padding-bottom: 86px;
      }
    }

    @media (max-width: 768px) {
      .settings-panel {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: 85%;
        max-width: 320px;
        transform: translateX(100%);
        background: #fff;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        padding: 28px;
        z-index: 990;
      }

      .settings-panel.open {
        transform: translateX(0);
      }

      #convert-btn-mobile {
        position: fixed;
        right: 18px;
        bottom: calc(var(--footer-h) + var(--fab-bottom-base));
        z-index: 940;
        min-width: 56px;
        padding-left: 12px;
        padding-right: 12px;
        border-radius: 999px;
      }

      .add-more-btn {
        position: fixed;
        right: 18px;
        bottom: calc(var(--footer-h) + var(--fab-bottom-base) + var(--fab-vertical-gap));
        z-index: 940;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        background: #fff;
      }

      #open-settings {
        position: fixed;
        right: 18px;
        bottom: calc(var(--footer-h) + var(--fab-bottom-base) + calc(var(--fab-vertical-gap) * 2));
        z-index: 940;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        background: #fff;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }

    .file-input {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0 0 0 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    body.panel-open .add-more-btn,
    body.panel-open #open-settings,
    body.panel-open #convert-btn-mobile {
      z-index: 880 !important;
    }

    .paper-page {
      background: white;
      border-radius: 4px;
      box-shadow: 0 6px 20px rgba(136, 135, 135, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      transition: all 0.3s;
    }

    .paper-page img {
      display: block;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .paper-page .pdf-icon {
      font-size: 48px;
      color: #ef4444;
    }

    .thumbnail-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.18s;
    }

    .thumbnail-container:hover .thumbnail-actions,
    .paper-page:hover .thumbnail-actions {
      opacity: 1;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      cursor: pointer;
    }

    /* --- option card styling updated to match image --- */
    .option-card {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      display: flex;
      gap: 12px;
      align-items: center;
      background: white;
    }

    .option-card .radio {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #d1d5db;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-left: 2px;
    }

    .option-card .radio .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: transparent;
    }

    .option-card .text {
      text-align: left;
    }

    .option-card .title {
      font-weight: 600;
      color: #111827;
      line-height: 1.05;
    }

    .option-card .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    .option-card.selected {
      border-color: #ef4444;
      background: #fffaf9;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.06);
    }

    .option-card.selected .radio {
      border-color: #ef4444;
    }

    .option-card.selected .radio .dot {
      background: #ef4444;
    }

    .thumbnail-container {
      position: relative;
      transition: transform 180ms cubic-bezier(0.2, 0.9, 0.2, 1),
        box-shadow 180ms, opacity 120ms;
      cursor: grab;
    }

    .thumbnail-container.dragging {
      cursor: grabbing;
      opacity: 0.6;
      transform: scale(0.98);
    }

    .thumbnail-container.drag-over {
      transform: translateY(-6px) scale(1.02);
    }

    /* new sections */

    .pdf-sections {
      max-width: 1200px;
      margin: 48px auto;
      padding: 0 18px;
      font-family: Inter, system-ui, sans-serif;
      color: #111827;
    }

    .section-head {
      text-align: center;
      margin-bottom: 24px;
    }

    .section-head h2 {
      font-size: 1.6rem;
      font-weight: 700;
      margin: 0;
    }

    /* Steps */
    .steps-3-wrap {
      text-align: center;
      margin-top: 18px;
    }

    .steps-3-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 36px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .steps-3-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 560px) {
      .steps-3-grid {
        grid-template-columns: 1fr;
      }
    }

    .step-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 12px;
    }

    .step-badge {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ef4444;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.15);
    }

    .step-title {
      font-weight: 700;
      font-size: 1rem;
      margin: 4px 0;
    }

    .step-desc {
      margin: 0;
      color: #6b7280;
      font-size: 0.93rem;
      line-height: 1.6;
    }

    /* Explore Tools */
    .card-grid {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
    }

    .tool-link {
      text-decoration: none;
      color: inherit;
    }

    .tool-card {
      background: #fff;
      border: 1px solid #eef2f6;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.03);
      display: flex;
      gap: 14px;
      align-items: flex-start;
      transition: transform .16s ease, box-shadow .16s ease;
    }

    .tool-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 14px 36px rgba(2, 6, 23, 0.06);
    }

    .tool-icon {
      min-width: 48px;
      min-height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .icon-blue {
      background: rgba(37, 99, 235, 0.08);
    }

    .icon-red {
      background: rgba(239, 68, 68, 0.08);
    }

    .icon-orange {
      background: rgba(234, 88, 12, 0.08);
    }

    .icon-green {
      background: rgba(5, 150, 105, 0.08);
    }

    .icon-purple {
      background: rgba(124, 58, 237, 0.08);
    }

    .tool-card h3 {
      margin: 0 0 6px 0;
      font-size: 0.98rem;
      font-weight: 700;
      color: #0f172a;
    }

    .tool-card p {
      margin: 0;
      color: #6b7280;
      font-size: 0.92rem;
      line-height: 1.55;
    }

    /* Info sections */
    .info-text {
      /* max-width: 900px; */
      margin: 0 auto;
      text-align: center;
      color: #374151;
      line-height: 1.7;
      font-size: 0.96rem;
    }

    .info-list {
      /* max-width: 800px; */
      margin: 0 auto;
      padding-left: 20px;
      color: #374151;
      line-height: 1.7;
      font-size: 0.95rem;
    }

    .article-wrap {
      /* max-width: 900px; */
      margin: 0 auto;
      line-height: 1.7;
      color: #374151;
      font-size: 0.95rem;
    }
  </style>
  </style>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-57TC57Z3"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <!-- mobile sidebar -->
  <div id="mobile-sidebar" class="mobile-sidebar" aria-hidden="true">
    <button id="mobile-sidebar-close" class="close">✕</button>
    <nav>
      <a href="https://www.pdf99.org/">Home</a>
      <a href="pdf-converter">PDF Converter</a>
      <a href="compress-pdf">Compress PDF</a>
      <a href="merge-pdf">Merge PDF</a>

      <hr style="margin: 12px 0; border: none; border-top: 1px solid #eef2f6" />

      <div>
        <div id="mobile-more-toggle" class="mobile-more-toggle">
          <span>More</span>
          <i id="mobile-more-icon" class="fas fa-chevron-down"></i>
        </div>
        <div id="mobile-more-list" class="mobile-more-list">
          <a href="jpg-to-pdf">JPG to PDF</a>
          <a href="split-pdf">Split PDF</a>
        </div>
      </div>
    </nav>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- NAV -->
  <nav class="site-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-inner">
      <div class="nav-left">
        <div class="brand">
          <!-- <h1 class="text-2xl font-bold text-red-600">PDF99</h1> -->
           <a href="/" class="text-2xl font-bold text-red-600">PDF99</a>
        </div>
      </div>

      <div class="nav-center" aria-hidden="false">
        <div class="nav-links">
          <a href="https://www.pdf99.org/" class="hover:text-red-600">Home</a>
          <a href="pdf-converter" class="hover:text-red-600">PDF Converter</a>
          <a href="compress-pdf" class="hover:text-red-600">Compress PDF</a>
          <a href="merge-pdf" class="hover:text-red-600">Merge PDF</a>
        </div>
      </div>

      <div class="nav-right">
        <div class="more-dropdown" id="more-dropdown">
          <button id="more-dropdown-toggle" class="px-2 py-1 inline-flex items-center gap-2" aria-haspopup="true"
            aria-expanded="false">
            More
            <i class="fas fa-chevron-down" style="font-size: 12px" aria-hidden="true"></i>
          </button>
          <div id="more-dropdown-menu" class="more-dropdown-menu" aria-hidden="true">
            <a href="jpg-to-pdf">JPG to PDF</a>
            <a href="split-pdf">Split PDF</a>
          </div>
        </div>

        <button id="mobile-hamburger" class="mobile-hamburger" aria-label="Open menu">
          <i class="fas fa-bars" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- main content -->
  <div class="page-wrap">
    <main>
      <!-- Upload -->
      <div id="upload-screen" class="flex flex-col items-center justify-center py-16">
        <h1 id="page-title" class="text-3xl font-bold text-center mb-6">
          Compress PDF
        </h1>
        <p class="text-gray-600 text-center mb-8">
          Reduce PDF size instantly in your browser.
        </p>

        <div id="drop-area"
          class="relative border-2 border-dashed border-gray-300 rounded-xl p-12 text-center bg-white max-w-md w-full">
          <label for="file-input" class="cursor-pointer">
            <div
              class="bg-red-600 text-white font-medium py-3 px-6 rounded-full shadow-md hover:bg-red-700 transition mb-4">
              Select PDFs
            </div>
            <p class="text-gray-500">- or drop PDF files here -</p>
          </label>

          <!-- main file input (visually hidden but available) -->
          <input id="file-input" class="file-input" type="file" accept="application/pdf" multiple />
        </div>

        <div class="flex justify-center space-x-6 mt-8">
          <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
            <i class="fas fa-file-pdf text-gray-600"></i>
          </div>
          <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
            <i class="fas fa-compress text-gray-600"></i>
          </div>
          <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
            <i class="fas fa-download text-gray-600"></i>
          </div>
        </div>


        <!-- ===== HTML for Compress PDF page ===== -->
        <div class="pdf-sections">

          <!-- Steps -->
          <section>
            <div class="section-head mt-20">
              <h2>How to Compress a PDF Online</h2>
            </div>
            <div class="steps-3-wrap">
              <div class="steps-3-grid">
                <div class="step-inner">
                  <div class="step-badge">1</div>
                  <div class="step-title">Upload</div>
                  <p class="step-desc">Select the PDF file you want to compress. Large or small - all files are
                    supported.</p>
                </div>
                <div class="step-inner">
                  <div class="step-badge">2</div>
                  <div class="step-title">Compress</div>
                  <p class="step-desc">Choose between strong or balanced compression, and let our tool reduce your file
                    size.</p>
                </div>
                <div class="step-inner">
                  <div class="step-badge">3</div>
                  <div class="step-title">Download</div>
                  <p class="step-desc">Download your optimized PDF instantly, with quality preserved and storage saved.
                  </p>
                </div>
              </div>
            </div>
          </section>

          <!-- Explore Tools -->
          <section style="margin-top:60px;">
            <div class="section-head">
              <h2>Explore Other PDF Tools</h2>
            </div>
            <div class="card-grid">
              <a href="pdf-converter" class="tool-link">
                <div class="tool-card">
                  <div class="tool-icon icon-blue"><i class="fas fa-file-pdf"></i></div>
                  <div>
                    <h3>PDF Converter</h3>
                    <p>Convert Word, Excel, PPT, and images to PDF and back - preserve formatting and layout.</p>
                  </div>
                </div>
              </a>
              <a href="merge-pdf" class="tool-link">
                <div class="tool-card">
                  <div class="tool-icon icon-red"><i class="fas fa-layer-group"></i></div>
                  <div>
                    <h3>Merge PDF</h3>
                    <p>Combine multiple PDFs into one document. Reorder, preview, and merge in seconds.</p>
                  </div>
                </div>
              </a>
              <a href="split-pdf" class="tool-link">
                <div class="tool-card">
                  <div class="tool-icon icon-orange"><i class="fas fa-cut"></i></div>
                  <div>
                    <h3>Split PDF</h3>
                    <p>Extract pages or ranges into separate PDF files - useful for reorganizing and sharing.</p>
                  </div>
                </div>
              </a>
              <a href="jpg-to-pdf" class="tool-link">
                <div class="tool-card">
                  <div class="tool-icon icon-purple"><i class="fas fa-image"></i></div>
                  <div>
                    <h3>JPG to PDF</h3>
                    <p>Convert JPG and PNG images into high-quality PDFs. Merge images into one file or export
                      separately.</p>
                  </div>
                </div>
              </a>
            </div>
          </section>

          <!-- What is PDF Compression -->
          <section style="margin-top:60px;">
            <div class="section-head">
              <h2>What is PDF Compression?</h2>
            </div>
            <p class="info-text">
              PDF compression reduces the file size of a PDF by optimizing images, fonts, and elements while preserving
              readable quality. This makes your PDFs easier to share by email, upload online, and store efficiently
              without sacrificing clarity.
            </p>
          </section>

          <!-- Why Compress -->
          <section style="margin-top:60px;">
            <div class="section-head">
              <h2>Why Compress PDF Files?</h2>
            </div>
            <ul class="info-list">
              <li><strong>Faster sharing:</strong> Smaller PDFs are quicker to send via email or messaging apps.</li>
              <li><strong>Save storage:</strong> Compressed PDFs take up less space on your device and cloud.</li>
              <li><strong>Better performance:</strong> Optimized files open faster on all devices.</li>
              <li><strong>Web upload ready:</strong> Many online platforms have strict file size limits - compression
                ensures compatibility.</li>
            </ul>
          </section>

          <!-- Article -->
          <section style="margin-top:60px;">
            <div class="section-head">
              <h2>Compress PDF - Complete Guide</h2>
            </div>
            <div class="article-wrap">
              <p>Large PDFs can be difficult to share and store, especially if they contain images, scans, or graphics.
                By compressing a PDF, you reduce its size without losing essential quality. PDF99’s compression tool
                lets you choose between aggressive or balanced compression levels to fit your needs.</p>

              <h3>Best practices</h3>
              <ol>
                <li><strong>Choose the right mode:</strong> Use balanced compression for documents and aggressive for
                  image-heavy PDFs.</li>
                <li><strong>Check readability:</strong> Ensure text and graphics remain clear after compression.</li>
                <li><strong>Batch process:</strong> Combine multiple PDFs first, then compress to optimize size
                  efficiently.</li>
                <li><strong>Secure sharing:</strong> Smaller files are easier to upload to websites, forms, or email
                  attachments.</li>
              </ol>

              <h3>When to use</h3>
              <p>Compress PDF files when you need to submit forms online, email reports, or archive large batches of
                scanned documents. The tool is especially useful for students, professionals, and businesses that deal
                with frequent document sharing.</p>
            </div>
          </section>

        </div>
      </div>

      <!-- Preview -->
      <div id="preview-screen" class="hidden">
        <div class="main-content">
          <div style="display: flex; gap: 18px; position: relative">
            <div class="thumbnails-section mt-10 mb-10" style="flex: 1">
              <div id="thumbnails-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-2"></div>
            </div>

            <button id="add-more-btn" class="add-more-btn" title="Add more PDFs" aria-label="Add more">
              <i class="fas fa-plus text-red-600 text-xl"></i>
            </button>

            <div class="settings-section settings-panel" id="settings-panel" aria-hidden="false">
              <div class="content-padding-bottom">
                <div class="flex justify-between items-center mb-6">
                  <h3 class="text-lg font-semibold">Compression level</h3>
                  <button id="close-settings" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl" aria-hidden="true"></i>
                  </button>
                </div>

                <div class="space-y-4">
                  <div class="option-card selected" data-quality="0.65" id="quality-recommended" role="button"
                    tabindex="0">
                    <div class="radio" aria-hidden="true">
                      <span class="dot"></span>
                    </div>
                    <div class="text">
                      <div class="title">Recommended Compression</div>
                      <div class="subtitle">
                        Good quality. Great compression
                      </div>
                    </div>
                  </div>

                  <div class="option-card" data-quality="0.3" id="quality-extreme" role="button" tabindex="0">
                    <div class="radio" aria-hidden="true">
                      <span class="dot"></span>
                    </div>
                    <div class="text">
                      <div class="title">Extreme Compression</div>
                      <div class="subtitle">
                        Less quality. High compression
                      </div>
                    </div>
                  </div>

                  <div class="option-card" data-quality="0.92" id="quality-less" role="button" tabindex="0">
                    <div class="radio" aria-hidden="true">
                      <span class="dot"></span>
                    </div>
                    <div class="text">
                      <div class="title">Less Compression</div>
                      <div class="subtitle">
                        High quality. Less compression
                      </div>
                    </div>
                  </div>

                  <!-- NEW: Render quality + JPEG quality controls -->
                  <div class="mt-3 border rounded p-3 bg-white">
                    <div class="text-sm font-medium mb-2">
                      Render quality (pixel scale)
                    </div>
                    <select id="render-quality-select" class="w-full p-2 rounded border">
                      <option value="1.5">Medium (1.5) - balanced</option>
                      <option value="2" selected>High (2.0) - sharper</option>
                      <option value="2.5">
                        Very high (2.5) - slow / larger files
                      </option>
                    </select>

                    <div class="mt-3 text-sm font-medium mb-2">
                      JPEG quality (<span id="jpeg-quality-val">92</span>%)
                    </div>
                    <input id="jpeg-quality-range" type="range" min="30" max="100" value="92" class="w-full" />
                    <div class="text-xs text-gray-500 mt-2">
                      Higher = better image quality but larger file size.
                    </div>
                  </div>

                  <button id="convert-btn-desktop"
                    class="hidden md:block bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-full shadow-md flex items-center justify-center">
                    <span>Compress PDF</span><i class="fas fa-download ml-2" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button id="convert-btn-mobile"
          class="convert-btn bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-full shadow-md flex items-center justify-center md:hidden">
          <span>Compress PDF</span><i class="fas fa-download ml-2" aria-hidden="true"></i>
        </button>

        <button id="open-settings" class="md:hidden" aria-label="Open settings">
          <i class="fas fa-cog text-gray-700 text-xl" aria-hidden="true"></i>
        </button>

        <input id="add-more-input" class="file-input" type="file" accept="application/pdf" multiple />
      </div>

      <!-- Download Screen (unchanged style) -->
      <div id="download-screen" class="hidden py-16 text-center">
        <h2 class="text-3xl font-bold mb-6">
          Your PDFs have been compressed
        </h2>
        <div class="bg-white rounded-xl shadow-sm p-8 max-w-md mx-auto mb-8">
          <h3 class="text-xl font-semibold mb-6">Download</h3>
          <button id="download-pdf"
            class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-8 rounded-full shadow-md mb-6">
            Download File
          </button>

          <div id="download-file-list" class="text-sm text-gray-700"></div>

          <div class="flex justify-center space-x-4 mb-8">
            <button class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
              <i class="fas fa-eye text-gray-600" aria-hidden="true"></i>
            </button>
            <button class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
              <i class="fas fa-pen text-gray-600" aria-hidden="true"></i>
            </button>
            <button class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
              <i class="fas fa-link text-gray-600" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <div class="max-w-md mx-auto flex justify-center space-x-4">
          <button id="back-to-edit" class="text-red-600 hover:text-red-800 font-medium">
            ← Back to edit
          </button>
          <button id="convert-more" class="text-red-600 hover:text-red-800 font-medium">
            Compress more files →
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- footer -->
  <footer class="site-footer">
    <div class="text-sm text-gray-700">©
      <script>
        document.write(new Date().getFullYear());
      </script>
      PDF99 - All rights reserved.
  </footer>

  <!-- Converting overlay (shown only during compression) -->
  <div id="converting-overlay" aria-hidden="true" style="
        display: none;
        position: fixed;
        inset: 0;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.95);
        z-index: 1400;
        flex-direction: column;
      ">
    <div style="
          width: 92%;
          max-width: 520px;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 16px;
        ">
      <div style="width: 140px; height: 140px; position: relative">
        <svg width="140" height="140" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="gradient" x1="0%" x2="100%">
              <stop offset="0%" stop-color="#ef4444" />
              <stop offset="100%" stop-color="#fb7185" />
            </linearGradient>
          </defs>
          <circle class="ring-bg" cx="70" cy="70" r="52" fill="none" stroke="#f3f4f6" stroke-width="10"></circle>
          <circle id="ring-fg" class="ring-fg" cx="70" cy="70" r="52" fill="none" stroke="url(#gradient)"
            stroke-width="10" stroke-dasharray="326.725" stroke-dashoffset="326.725"></circle>
        </svg>
        <div style="
              position: absolute;
              left: 0;
              right: 0;
              top: 0;
              bottom: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-direction: column;
              pointer-events: none;
            ">
          <div id="ring-percent" style="font-size: 20px; font-weight: 700; color: #111827">
            0%
          </div>
          <div id="ring-status" style="font-size: 13px; color: #6b7280; margin-top: 6px">
            Processing
          </div>
        </div>
      </div>
      <div style="text-align: center; color: #111827; font-weight: 600">
        Compressing, please wait...
      </div>
    </div>
  </div>

  <!-- JS: UI helpers + app JS -->
  <script>
    // UI helpers (dropdown, mobile sidebar, stacked buttons)
    (function () {
      const moreToggle = document.getElementById("more-dropdown-toggle");
      const moreMenu = document.getElementById("more-dropdown-menu");
      if (moreToggle) {
        moreToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          moreMenu.classList.toggle("open");
        });
        document.addEventListener("click", () => {
          moreMenu.classList.remove("open");
        });
      }

      const mobileHamburger = document.getElementById("mobile-hamburger");
      const mobileSidebar = document.getElementById("mobile-sidebar");
      const mobileSidebarClose = document.getElementById(
        "mobile-sidebar-close"
      );
      const overlay = document.getElementById("overlay");

      const mobileMoreToggle = document.getElementById("mobile-more-toggle");
      const mobileMoreList = document.getElementById("mobile-more-list");
      const mobileMoreIcon = document.getElementById("mobile-more-icon");

      if (mobileMoreToggle) {
        mobileMoreToggle.addEventListener("click", () => {
          const isOpen = mobileMoreList.classList.toggle("open");
          mobileMoreIcon.classList.toggle("fa-chevron-down", !isOpen);
          mobileMoreIcon.classList.toggle("fa-chevron-up", isOpen);
        });
      }

      mobileHamburger &&
        mobileHamburger.addEventListener("click", () => {
          mobileSidebar.classList.add("open");
          mobileSidebar.setAttribute("aria-hidden", "false");
          overlay.classList.add("open");
          document.body.classList.add("panel-open");
        });
      mobileSidebarClose &&
        mobileSidebarClose.addEventListener("click", () => {
          mobileSidebar.classList.remove("open");
          mobileSidebar.setAttribute("aria-hidden", "true");
          overlay.classList.remove("open");
          document.body.classList.remove("panel-open");
        });

      overlay &&
        overlay.addEventListener("click", () => {
          mobileSidebar && mobileSidebar.classList.remove("open");
          document.querySelector(".settings-panel") &&
            document
              .querySelector(".settings-panel")
              .classList.remove("open");
          overlay.classList.remove("open");
          document.body.classList.remove("panel-open");
        });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document.getElementById("more-dropdown-menu") &&
            document
              .getElementById("more-dropdown-menu")
              .classList.remove("open");
          mobileSidebar && mobileSidebar.classList.remove("open");
          document.querySelector(".settings-panel") &&
            document
              .querySelector(".settings-panel")
              .classList.remove("open");
          overlay && overlay.classList.remove("open");
          document.body.classList.remove("panel-open");
        }
      });
    })();

    // ===== app JS =====
    const jsPDF =
      window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;
    if (!jsPDF) {
      console.error("jsPDF not loaded");
    }

    const state = {
      files: [], // { file: File, pages: number|null, origSize: number }
      quality: 0.92, // default JPEG quality (0..1)
      renderScale: 2.0, // default render pixel scale (higher = sharper)
      outputs: [], // { name, blob, originalSize, newSize, compressed }
    };

    const fileInput = document.getElementById("file-input");
    const addMoreInput = document.getElementById("add-more-input");
    const thumbnailsContainer = document.getElementById(
      "thumbnails-container"
    );
    const convertBtnMobile = document.getElementById("convert-btn-mobile");
    const convertBtnDesktop = document.getElementById("convert-btn-desktop");
    const downloadPdfBtn = document.getElementById("download-pdf");
    const backToEditBtn = document.getElementById("back-to-edit");
    const convertMoreBtn = document.getElementById("convert-more");
    const addMoreBtnRef = document.getElementById("add-more-btn");
    const qualityRecommended = document.getElementById("quality-recommended");
    const qualityExtreme = document.getElementById("quality-extreme");
    const qualityLess = document.getElementById("quality-less");
    const convertingOverlay = document.getElementById("converting-overlay");
    const ringFg = document.getElementById("ring-fg");
    const ringPercentEl = document.getElementById("ring-percent");
    const ringStatusEl = document.getElementById("ring-status");
    const downloadFileList = document.getElementById("download-file-list");

    // UI controls
    const renderQualitySelect = document.getElementById(
      "render-quality-select"
    );
    const jpegQualityRange = document.getElementById("jpeg-quality-range");
    const jpegQualityVal = document.getElementById("jpeg-quality-val");

    document.addEventListener("DOMContentLoaded", init);
    function init() {
      setupListeners();
      // initialize UI controls values
      if (renderQualitySelect)
        renderQualitySelect.value = String(state.renderScale);
      if (jpegQualityRange)
        jpegQualityRange.value = String(Math.round(state.quality * 100));
      if (jpegQualityVal)
        jpegQualityVal.textContent = String(Math.round(state.quality * 100));
      selectQuality(0.65);
    }

    function setupListeners() {
      fileInput && fileInput.addEventListener("change", handleFileSelect);
      addMoreInput &&
        addMoreInput.addEventListener("change", handleAddMoreFiles);
      addMoreBtnRef &&
        addMoreBtnRef.addEventListener(
          "click",
          () => addMoreInput && addMoreInput.click()
        );
      convertBtnMobile &&
        convertBtnMobile.addEventListener("click", handleConvert);
      convertBtnDesktop &&
        convertBtnDesktop.addEventListener("click", handleConvert);
      downloadPdfBtn &&
        downloadPdfBtn.addEventListener("click", handleDownload);
      backToEditBtn &&
        backToEditBtn.addEventListener("click", () => {
          document.getElementById("download-screen").classList.add("hidden");
          document
            .getElementById("preview-screen")
            .classList.remove("hidden");
        });
      convertMoreBtn && convertMoreBtn.addEventListener("click", resetApp);

      qualityRecommended &&
        qualityRecommended.addEventListener("click", () =>
          selectQuality(parseFloat(qualityRecommended.dataset.quality))
        );
      qualityExtreme &&
        qualityExtreme.addEventListener("click", () =>
          selectQuality(parseFloat(qualityExtreme.dataset.quality))
        );
      qualityLess &&
        qualityLess.addEventListener("click", () =>
          selectQuality(parseFloat(qualityLess.dataset.quality))
        );

      // renderQuality / jpegQuality wiring
      if (renderQualitySelect) {
        renderQualitySelect.addEventListener("change", (e) => {
          const v = parseFloat(e.target.value);
          if (!isNaN(v) && v > 0) state.renderScale = v;
        });
      }

      if (jpegQualityRange) {
        jpegQualityRange.addEventListener("input", (e) => {
          const pct = parseInt(e.target.value, 10);
          if (jpegQualityVal) jpegQualityVal.textContent = String(pct);
          state.quality = Math.max(0.01, Math.min(1, pct / 100));
        });
      }

      // keyboard accessible activation
      [qualityRecommended, qualityExtreme, qualityLess].forEach((el) => {
        if (!el) return;
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            el.click();
          }
        });
      });

      // mobile settings open/close
      const openSettingsBtnRef = document.getElementById("open-settings");
      const closeSettingsBtnRef = document.getElementById("close-settings");
      const settingsPanelRef = document.querySelector(".settings-panel");
      const overlayRef = document.getElementById("overlay");
      openSettingsBtnRef &&
        openSettingsBtnRef.addEventListener("click", () => {
          settingsPanelRef && settingsPanelRef.classList.add("open");
          overlayRef && overlayRef.classList.add("open");
          document.body.classList.add("panel-open");
        });
      closeSettingsBtnRef &&
        closeSettingsBtnRef.addEventListener("click", () => {
          settingsPanelRef && settingsPanelRef.classList.remove("open");
          overlayRef && overlayRef.classList.remove("open");
          document.body.classList.remove("panel-open");
        });
      overlayRef &&
        overlayRef.addEventListener("click", () => {
          settingsPanelRef && settingsPanelRef.classList.remove("open");
          overlayRef && overlayRef.classList.remove("open");
          document.body.classList.remove("panel-open");
        });

      // drag/drop
      const dropArea = document.getElementById("drop-area");
      ["dragenter", "dragover", "dragleave", "drop"].forEach(
        (evt) =>
          dropArea && dropArea.addEventListener(evt, preventDefaults, false)
      );
      ["dragenter", "dragover"].forEach(
        (evt) => dropArea && dropArea.addEventListener(evt, highlight, false)
      );
      ["dragleave", "drop"].forEach(
        (evt) =>
          dropArea && dropArea.addEventListener(evt, unhighlight, false)
      );
      dropArea && dropArea.addEventListener("drop", handleDrop, false);
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    function highlight() {
      const dropArea = document.getElementById("drop-area");
      dropArea && dropArea.classList.add("border-red-500", "bg-red-50");
    }
    function unhighlight() {
      const dropArea = document.getElementById("drop-area");
      dropArea && dropArea.classList.remove("border-red-500", "bg-red-50");
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      handleFiles(dt.files);
    }

    function handleFileSelect(e) {
      handleFiles(e.target.files);
      e.target.value = "";
    }
    function handleAddMoreFiles(e) {
      handleFiles(e.target.files);
      e.target.value = "";
    }

    // NOTE: no overlay during file reading - overlay appears only during compression
    async function handleFiles(files) {
      if (!files || files.length === 0) return;
      const pdfFiles = Array.from(files).filter(
        (f) =>
          f.type === "application/pdf" ||
          f.name.toLowerCase().endsWith(".pdf")
      );
      if (pdfFiles.length === 0) {
        alert("Please select PDF files only.");
        return;
      }

      for (const file of pdfFiles) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          try {
            const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer })
              .promise;
            state.files.push({
              file,
              pages: pdfDoc.numPages,
              origSize: file.size,
            });
            try {
              pdfDoc.destroy && pdfDoc.destroy();
            } catch (e) { }
          } catch (err) {
            state.files.push({ file, pages: null, origSize: file.size });
          }
        } catch (err) {
          state.files.push({ file, pages: null, origSize: file.size });
        }
        await new Promise((r) => setTimeout(r, 10)); // keep UI responsive
      }

      if (state.files.length > 0) showPreviewScreen();
    }

    function showPreviewScreen() {
      document.getElementById("upload-screen").classList.add("hidden");
      document.getElementById("preview-screen").classList.remove("hidden");
      renderThumbnails();
    }

    function renderThumbnails() {
      thumbnailsContainer && (thumbnailsContainer.innerHTML = "");
      const width = 160;
      const height = 220;

      state.files.forEach((fileObj, index) => {
        const { file, pages, origSize } = fileObj;
        const container = document.createElement("div");
        container.className = "thumbnail-container relative";
        container.dataset.index = index;
        container.style.minHeight = height + 64 + "px";

        const inner = document.createElement("div");
        inner.className = "paper-page mb-3";
        inner.style.width = width + "px";
        inner.style.height = height + "px";
        inner.style.margin = "0 auto";
        inner.style.position = "relative";
        inner.style.overflow = "hidden";
        inner.innerHTML = `<i class="fas fa-file-pdf pdf-icon" aria-hidden="true"></i>`;

        const actions = document.createElement("div");
        actions.className = "thumbnail-actions";
        actions.style.top = "8px";
        actions.style.right = "8px";

        // remove entire PDF button
        const removeBtn = document.createElement("div");
        removeBtn.className = "action-btn remove-btn";
        removeBtn.setAttribute("title", "Remove file");
        removeBtn.innerHTML =
          '<i class="fas fa-times text-gray-700" aria-hidden="true"></i>';
        removeBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          removeFile(index);
        });

        actions.appendChild(removeBtn);
        inner.appendChild(actions);

        const meta = document.createElement("div");
        meta.className = "text-center mt-2";
        const nameEsc = escapeHtml(file.name);
        const sizeTxt = formatFileSize(origSize || file.size);
        const pagesTxt = pages ? `${pages} pages` : `-`;
        meta.innerHTML = `<p class="text-sm font-medium truncate" title="${nameEsc}">${nameEsc}</p><p class="text-xs text-gray-500">${sizeTxt} • ${pagesTxt}</p>`;

        container.appendChild(inner);
        container.appendChild(meta);
        thumbnailsContainer && thumbnailsContainer.appendChild(container);
      });
    }

    function escapeHtml(text) {
      return (text + "").replace(
        /[&<>"']/g,
        (m) =>
        ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[m])
      );
    }

    function removeFile(index) {
      state.files.splice(index, 1);
      if (state.files.length === 0) {
        document.getElementById("preview-screen").classList.add("hidden");
        document.getElementById("upload-screen").classList.remove("hidden");
      } else renderThumbnails();
    }

    function selectQuality(q) {
      state.quality = q;
      document
        .querySelectorAll(".option-card")
        .forEach((el) => el.classList.remove("selected"));
      if (q === 0.65)
        qualityRecommended && qualityRecommended.classList.add("selected");
      else if (q === 0.3)
        qualityExtreme && qualityExtreme.classList.add("selected");
      else if (q === 0.92)
        qualityLess && qualityLess.classList.add("selected");
    }

    function showConvertingOverlayCustom(show, statusText) {
      if (show) {
        ringPercentEl && (ringPercentEl.textContent = "0%");
        ringStatusEl &&
          (ringStatusEl.textContent = statusText || "Processing");
        convertingOverlay && (convertingOverlay.style.display = "flex");
      } else {
        convertingOverlay && (convertingOverlay.style.display = "none");
      }
    }

    // compressAllFiles: rasterize pages via pdf.js, encode JPEG with selected quality, rebuild with jsPDF
    async function compressAllFiles() {
      const outputs = [];
      for (let i = 0; i < state.files.length; i++) {
        const item = state.files[i];
        const file = item.file;
        const nameBase = file.name.replace(/\.[^/.]+$/, "");
        const arrayBuffer = await file.arrayBuffer();
        let pdf;
        try {
          const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
          pdf = await loadingTask.promise;
        } catch (e) {
          // if pdf.js fails, fall back to original file
          outputs.push({
            name: file.name,
            blob: file,
            originalSize: item.origSize || file.size,
            newSize: item.origSize || file.size,
            compressed: false,
          });
          continue;
        }

        const numPages = pdf.numPages;
        const pageImages = [];

        for (let p = 1; p <= numPages; p++) {
          try {
            const page = await pdf.getPage(p);

            // Get original PDF page size in "points" (scale:1) - includes rotation
            const viewportAt1 = page.getViewport({ scale: 1 });

            // Render at higher pixel scale for quality (user-configurable)
            const renderScale =
              typeof state.renderScale === "number" ? state.renderScale : 2.0;
            const viewport = page.getViewport({ scale: renderScale });

            // Create canvas at the rendered pixel size
            const canvas = document.createElement("canvas");
            canvas.width = Math.round(viewport.width);
            canvas.height = Math.round(viewport.height);
            const ctx = canvas.getContext("2d");

            // Render page to canvas
            await page.render({ canvasContext: ctx, viewport }).promise;

            // Use JPEG by default (quality 0..1). For lossless use "image/png" (much larger).
            const q =
              typeof state.quality === "number" ? state.quality : 0.92;
            const dataUrl = canvas.toDataURL("image/jpeg", q);

            // Store both the rendered pixel size and the original page size (pts)
            pageImages.push({
              dataUrl,
              pixelWidth: canvas.width,
              pixelHeight: canvas.height,
              origWidthPts: viewportAt1.width,
              origHeightPts: viewportAt1.height,
            });

            try {
              page.cleanup && page.cleanup();
            } catch (e) { }
          } catch (errPage) {
            console.warn("Page render failed", errPage);
          }
        }

        try {
          pdf.destroy && pdf.destroy();
        } catch (e) { }

        if (pageImages.length === 0) {
          // nothing to pack -> fallback to original
          outputs.push({
            name: file.name,
            blob: file,
            originalSize: item.origSize || file.size,
            newSize: item.origSize || file.size,
            compressed: false,
          });
          continue;
        }

        // Build new PDF using jsPDF - use 'pt' units and the original page dimensions to preserve physical size
        let outPdf = null;
        try {
          for (let pi = 0; pi < pageImages.length; pi++) {
            const img = pageImages[pi];

            // Safety/clamp: very large page dims may cause issues in some viewers or exceed memory.
            // We preserve size when possible; if a dimension is extremely large, clamp to a safe max while
            // preserving aspect ratio. Adjust SAFE_MAX_PT if you want a different ceiling.
            const SAFE_MAX_PT = 2000 * 1.0; // 2000 points (~27.8 inches) default safe ceiling
            let pageW = img.origWidthPts;
            let pageH = img.origHeightPts;
            // If either dimension exceeds SAFE_MAX_PT, scale both down proportionally.
            if (pageW > SAFE_MAX_PT || pageH > SAFE_MAX_PT) {
              const scaleDown = Math.min(
                SAFE_MAX_PT / pageW,
                SAFE_MAX_PT / pageH
              );
              pageW = pageW * scaleDown;
              pageH = pageH * scaleDown;
            }

            if (pi === 0) {
              outPdf = new jsPDF({
                unit: "pt",
                format: [pageW, pageH],
              });
              outPdf.addImage(img.dataUrl, "JPEG", 0, 0, pageW, pageH);
            } else {
              outPdf.addPage([pageW, pageH]);
              outPdf.addImage(img.dataUrl, "JPEG", 0, 0, pageW, pageH);
            }
          }
        } catch (errBuild) {
          console.error("Building compressed PDF failed", errBuild);
        }

        if (!outPdf) {
          outputs.push({
            name: file.name,
            blob: file,
            originalSize: item.origSize || file.size,
            newSize: item.origSize || file.size,
            compressed: false,
          });
          continue;
        }

        const blob = outPdf.output("blob");

        // If compressed blob is not smaller, fallback to original to avoid forced expansion
        if (blob.size >= (item.origSize || file.size)) {
          outputs.push({
            name: file.name,
            blob: file,
            originalSize: item.origSize || file.size,
            newSize: item.origSize || file.size,
            compressed: false,
          });
        } else {
          outputs.push({
            name: `${nameBase}-compressed.pdf`,
            blob,
            originalSize: item.origSize || file.size,
            newSize: blob.size,
            compressed: true,
          });
        }
      }
      return outputs;
    }

    // UPDATED handleConvert: run ring animation (timed) AND compression in parallel.
    async function handleConvert() {
      if (state.files.length === 0) {
        alert("Please add at least one PDF.");
        return;
      }
      const duration = 5000; // keep original 5s animation
      showConvertingOverlayCustom(true, "Uploading");

      const animPromise = runRingAnimation(duration);
      const genPromise = compressAllFiles();

      try {
        const [_, outputs] = await Promise.all([animPromise, genPromise]);
        state.outputs = outputs;
        hideConvertingOverlay();
        document.getElementById("preview-screen").classList.add("hidden");
        document.getElementById("download-screen").classList.remove("hidden");
        renderDownloadList();
      } catch (err) {
        hideConvertingOverlay();
        console.error("Compression error:", err);
        alert("An error occurred while compressing. Please try again.");
      }
    }

    function hideConvertingOverlay() {
      convertingOverlay && (convertingOverlay.style.display = "none");
    }

    function runRingAnimation(durationMs) {
      return new Promise((resolve) => {
        const radius = 52;
        const circumference = 2 * Math.PI * radius;
        ringFg && (ringFg.style.strokeDasharray = circumference.toString());
        let start = performance.now();
        function tick(now) {
          const elapsed = now - start;
          const t = Math.min(1, elapsed / durationMs);
          const percent = Math.floor(t * 100);
          const offset = circumference * (1 - t);
          ringFg && (ringFg.style.strokeDashoffset = offset.toString());
          ringPercentEl && (ringPercentEl.textContent = percent + "%");
          if (percent < 50) {
            ringStatusEl && (ringStatusEl.textContent = "Uploading");
          } else {
            ringStatusEl && (ringStatusEl.textContent = "Compressing");
          }
          if (t < 1) requestAnimationFrame(tick);
          else {
            ringFg && (ringFg.style.strokeDashoffset = "0");
            ringPercentEl && (ringPercentEl.textContent = "100%");
            ringStatusEl && (ringStatusEl.textContent = "Compressing");
            setTimeout(resolve, 250);
          }
        }
        requestAnimationFrame(tick);
      });
    }

    function renderDownloadList() {
      if (!downloadFileList) return;
      downloadFileList.innerHTML = "";
      if (!state.outputs || state.outputs.length === 0) return;
      state.outputs.forEach((o) => {
        const before = formatFileSize(o.originalSize || 0);
        const after = formatFileSize(o.newSize || 0);
        let pct = 0;
        if (o.originalSize && o.newSize) {
          pct = Math.round(
            ((o.originalSize - o.newSize) / o.originalSize) * 100
          );
          if (pct < 0) pct = 0; // clamp negative to zero
        }
        const reductionText = pct > 0 ? `${pct}% smaller` : `No reduction`;
        const line = document.createElement("div");
        line.style.marginBottom = "14px";
        line.innerHTML = `<div style="margin-bottom:4px;font-weight:600">${escapeHtml(
          o.name
        )}</div>
                                  <div style="font-size:13px;color:#6b7280">${before} → ${after} (${reductionText})</div>`;
        downloadFileList.appendChild(line);
      });
    }

    function handleDownload() {
      if (!state.outputs || state.outputs.length === 0) {
        alert("No compressed file available. Please compress first.");
        return;
      }
      if (state.outputs.length === 1) {
        saveAs(state.outputs[0].blob, state.outputs[0].name);
      } else {
        const zip = new JSZip();
        state.outputs.forEach((o) => zip.file(o.name, o.blob));
        zip
          .generateAsync({ type: "blob" })
          .then((blob) =>
            saveAs(blob, `compressed-pdfs-${timestampString()}.zip`)
          );
      }
      downloadPdfBtn.innerHTML = "Downloading...";
            setTimeout(() => {
                downloadPdfBtn.innerHTML = "Download PDF";
            }, 1000);
    }

    function timestampString() {
      const now = new Date();
      return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(
        2,
        "0"
      )}${String(now.getDate()).padStart(2, "0")}-${String(
        now.getHours()
      ).padStart(2, "0")}${String(now.getMinutes()).padStart(2, "0")}${String(
        now.getSeconds()
      ).padStart(2, "0")}`;
    }

    function resetApp() {
      state.files = [];
      state.quality = 0.92;
      state.renderScale = 2.0;
      state.outputs = [];
      selectQuality(0.65);
      document.getElementById("download-screen").classList.add("hidden");
      document.getElementById("upload-screen").classList.remove("hidden");
      thumbnailsContainer && (thumbnailsContainer.innerHTML = "");
      downloadFileList && (downloadFileList.innerHTML = "");
    }

    function formatFileSize(bytes) {
      if (!bytes) return "0 B";
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function wait(ms) {
      return new Promise((r) => setTimeout(r, ms));
    }
  </script>

  <noscript>
    <div style="
          padding: 16px;
          background: #fff;
          border-radius: 8px;
          margin: 18px auto;
          max-width: 800px;
          text-align: center;
        ">
      This Compress PDF tool runs in the browser using JavaScript. Please
      enable JavaScript to use the tool.
    </div>
  </noscript>
</body>

</html>